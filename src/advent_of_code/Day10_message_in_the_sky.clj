(ns advent-of-code.Day10-message-in-the-sky
  (:require [clojure.string :as str]
            [clojure.set :refer [intersection union difference]]))

(def input "position=< 31766, -52454> velocity=<-3,  5>\nposition=<-52374, -41935> velocity=< 5,  4>\nposition=< 31758, -31427> velocity=<-3,  3>\nposition=<-41862,  31671> velocity=< 4, -3>\nposition=< 10747, -41934> velocity=<-1,  4>\nposition=< 21267,  42181> velocity=<-2, -4>\nposition=< 52759, -20913> velocity=<-5,  2>\nposition=< 31734,  52701> velocity=<-3, -5>\nposition=<-41823,  31669> velocity=< 4, -3>\nposition=<-52346,  42184> velocity=< 5, -4>\nposition=<-20801, -52451> velocity=< 2,  5>\nposition=< 31760, -20904> velocity=<-3,  2>\nposition=<-31356, -10397> velocity=< 3,  1>\nposition=<-41823, -41934> velocity=< 4,  4>\nposition=< 10724, -10389> velocity=<-1,  1>\nposition=<-31344, -31427> velocity=< 3,  3>\nposition=<-41826,  42186> velocity=< 4, -4>\nposition=<-52393,  42186> velocity=< 5, -4>\nposition=< 42281,  52698> velocity=<-4, -5>\nposition=< 10700, -10398> velocity=<-1,  1>\nposition=< 21259,  31667> velocity=<-2, -3>\nposition=< 21215,  31662> velocity=<-2, -3>\nposition=<-10294,  10635> velocity=< 1, -1>\nposition=< 31734, -10392> velocity=<-3,  1>\nposition=< 52764,  52698> velocity=<-5, -5>\nposition=<-52394,  21148> velocity=< 5, -2>\nposition=<-20809, -31428> velocity=< 2,  3>\nposition=<-52333,  31666> velocity=< 5, -3>\nposition=< 31787, -20913> velocity=<-3,  2>\nposition=< 52776, -10391> velocity=<-5,  1>\nposition=<-52393, -52449> velocity=< 5,  5>\nposition=< 31768,  52701> velocity=<-3, -5>\nposition=< 31734,  21155> velocity=<-3, -2>\nposition=<-41847, -52455> velocity=< 4,  5>\nposition=< 21220,  21147> velocity=<-2, -2>\nposition=< 42273,  10640> velocity=<-4, -1>\nposition=< 10753,  52696> velocity=<-1, -5>\nposition=<-10309, -10389> velocity=< 1,  1>\nposition=< 42241,  21149> velocity=<-4, -2>\nposition=< 52806,  52701> velocity=<-5, -5>\nposition=<-20801,  31670> velocity=< 2, -3>\nposition=< 10720,  21152> velocity=<-1, -2>\nposition=< 31737,  42181> velocity=<-3, -4>\nposition=<-31332, -20913> velocity=< 3,  2>\nposition=<-10321,  52695> velocity=< 1, -5>\nposition=<-10294,  31664> velocity=< 1, -3>\nposition=<-10331, -41943> velocity=< 1,  4>\nposition=< 52788, -10397> velocity=<-5,  1>\nposition=< 52766, -31428> velocity=<-5,  3>\nposition=<-31332, -52458> velocity=< 3,  5>\nposition=<-31356, -20909> velocity=< 3,  2>\nposition=<-10329, -52453> velocity=< 1,  5>\nposition=<-31346, -31419> velocity=< 3,  3>\nposition=< 31787,  10638> velocity=<-3, -1>\nposition=< 10736,  21152> velocity=<-1, -2>\nposition=< 21255, -31419> velocity=<-2,  3>\nposition=<-31308,  31669> velocity=< 3, -3>\nposition=<-52386,  42186> velocity=< 5, -4>\nposition=<-10314, -20912> velocity=< 1,  2>\nposition=< 31766, -41938> velocity=<-3,  4>\nposition=< 42273,  21149> velocity=<-4, -2>\nposition=< 21255, -31419> velocity=<-2,  3>\nposition=<-41860, -41934> velocity=< 4,  4>\nposition=<-20817, -31421> velocity=< 2,  3>\nposition=< 21231,  52695> velocity=<-2, -5>\nposition=<-20793,  21151> velocity=< 2, -2>\nposition=< 42274,  31671> velocity=<-4, -3>\nposition=<-31353,  10636> velocity=< 3, -1>\nposition=< 21235, -41937> velocity=<-2,  4>\nposition=< 21251, -52452> velocity=<-2,  5>\nposition=< 42289, -20905> velocity=<-4,  2>\nposition=< 52766,  31666> velocity=<-5, -3>\nposition=<-52357,  52701> velocity=< 5, -5>\nposition=<-52386, -41935> velocity=< 5,  4>\nposition=< 42260, -20913> velocity=<-4,  2>\nposition=<-20836,  42180> velocity=< 2, -4>\nposition=<-52386,  31670> velocity=< 5, -3>\nposition=< 10757, -10390> velocity=<-1,  1>\nposition=< 10752,  42183> velocity=<-1, -4>\nposition=<-52381,  10633> velocity=< 5, -1>\nposition=<-31332,  31667> velocity=< 3, -3>\nposition=< 21237,  52701> velocity=<-2, -5>\nposition=< 10731, -41934> velocity=<-1,  4>\nposition=< 31787, -31425> velocity=<-3,  3>\nposition=< 52757, -41943> velocity=<-5,  4>\nposition=<-52374,  52698> velocity=< 5, -5>\nposition=<-52338, -52456> velocity=< 5,  5>\nposition=<-20844,  42178> velocity=< 2, -4>\nposition=<-20825, -52456> velocity=< 2,  5>\nposition=<-52367, -10389> velocity=< 5,  1>\nposition=< 10744,  52697> velocity=<-1, -5>\nposition=< 10704, -52457> velocity=<-1,  5>\nposition=< 31766,  42186> velocity=<-3, -4>\nposition=< 52761, -10390> velocity=<-5,  1>\nposition=< 31777, -20904> velocity=<-3,  2>\nposition=<-41818, -41938> velocity=< 4,  4>\nposition=<-52370,  10637> velocity=< 5, -1>\nposition=< 21267,  10639> velocity=<-2, -1>\nposition=<-52382, -10394> velocity=< 5,  1>\nposition=<-52370,  42180> velocity=< 5, -4>\nposition=< 21223, -31428> velocity=<-2,  3>\nposition=<-20845, -20913> velocity=< 2,  2>\nposition=< 52812,  21148> velocity=<-5, -2>\nposition=< 42241, -41935> velocity=<-4,  4>\nposition=< 52814,  52696> velocity=<-5, -5>\nposition=<-31316, -10398> velocity=< 3,  1>\nposition=< 52776,  10636> velocity=<-5, -1>\nposition=<-41823,  21148> velocity=< 4, -2>\nposition=< 52788, -10391> velocity=<-5,  1>\nposition=<-52370,  42186> velocity=< 5, -4>\nposition=< 10721,  52701> velocity=<-1, -5>\nposition=< 10744,  42185> velocity=<-1, -4>\nposition=< 21219, -41939> velocity=<-2,  4>\nposition=<-52378, -52451> velocity=< 5,  5>\nposition=< 31758, -20911> velocity=<-3,  2>\nposition=<-31332,  52697> velocity=< 3, -5>\nposition=<-10329,  31671> velocity=< 1, -3>\nposition=<-31308,  42179> velocity=< 3, -4>\nposition=< 31726, -20911> velocity=<-3,  2>\nposition=< 42275,  52701> velocity=<-4, -5>\nposition=<-20829,  21149> velocity=< 2, -2>\nposition=< 10706,  52696> velocity=<-1, -5>\nposition=<-31312,  52701> velocity=< 3, -5>\nposition=<-31364, -10397> velocity=< 3,  1>\nposition=<-41855,  42179> velocity=< 4, -4>\nposition=<-41823,  31665> velocity=< 4, -3>\nposition=<-31362, -10389> velocity=< 3,  1>\nposition=< 42273, -20912> velocity=<-4,  2>\nposition=< 10700, -52453> velocity=<-1,  5>\nposition=< 52788,  21149> velocity=<-5, -2>\nposition=<-10324, -31424> velocity=< 1,  3>\nposition=<-31356, -31423> velocity=< 3,  3>\nposition=< 10725,  52701> velocity=<-1, -5>\nposition=<-52343,  42186> velocity=< 5, -4>\nposition=<-31324, -31425> velocity=< 3,  3>\nposition=< 52799, -31419> velocity=<-5,  3>\nposition=< 10716, -52458> velocity=<-1,  5>\nposition=<-20849,  10638> velocity=< 2, -1>\nposition=<-52378, -20905> velocity=< 5,  2>\nposition=< 52764, -10391> velocity=<-5,  1>\nposition=< 31726,  10635> velocity=<-3, -1>\nposition=< 31750, -20907> velocity=<-3,  2>\nposition=<-31344,  10636> velocity=< 3, -1>\nposition=<-41839, -10397> velocity=< 4,  1>\nposition=<-52333,  52701> velocity=< 5, -5>\nposition=< 52780, -41939> velocity=<-5,  4>\nposition=< 42242,  10641> velocity=<-4, -1>\nposition=< 10728, -20909> velocity=<-1,  2>\nposition=< 52780, -41943> velocity=<-5,  4>\nposition=< 31766, -41939> velocity=<-3,  4>\nposition=<-20846, -41934> velocity=< 2,  4>\nposition=<-31303,  10640> velocity=< 3, -1>\nposition=< 42282, -41934> velocity=<-4,  4>\nposition=< 52780, -20907> velocity=<-5,  2>\nposition=< 31726, -20908> velocity=<-3,  2>\nposition=<-10310,  31666> velocity=< 1, -3>\nposition=<-31316, -41940> velocity=< 3,  4>\nposition=<-20801,  10635> velocity=< 2, -1>\nposition=<-41859, -10396> velocity=< 4,  1>\nposition=< 31750,  31669> velocity=<-3, -3>\nposition=<-52370,  21151> velocity=< 5, -2>\nposition=<-31312, -52449> velocity=< 3,  5>\nposition=<-20821, -10389> velocity=< 2,  1>\nposition=< 10744,  42179> velocity=<-1, -4>\nposition=< 31766, -20909> velocity=<-3,  2>\nposition=<-41870,  52692> velocity=< 4, -5>\nposition=<-52366,  31671> velocity=< 5, -3>\nposition=<-31364, -41938> velocity=< 3,  4>\nposition=<-31324,  52700> velocity=< 3, -5>\nposition=< 42289, -52449> velocity=<-4,  5>\nposition=<-10298,  21156> velocity=< 1, -2>\nposition=< 21212,  31662> velocity=<-2, -3>\nposition=< 10696, -20907> velocity=<-1,  2>\nposition=< 52776,  52699> velocity=<-5, -5>\nposition=< 42261,  52697> velocity=<-4, -5>\nposition=< 21235, -20905> velocity=<-2,  2>\nposition=<-52334,  42181> velocity=< 5, -4>\nposition=< 52777, -31428> velocity=<-5,  3>\nposition=< 10716,  31665> velocity=<-1, -3>\nposition=< 52817, -41943> velocity=<-5,  4>\nposition=< 52798, -41934> velocity=<-5,  4>\nposition=<-52338,  52696> velocity=< 5, -5>\nposition=<-52338,  42178> velocity=< 5, -4>\nposition=< 31787,  42186> velocity=<-3, -4>\nposition=<-31356, -52454> velocity=< 3,  5>\nposition=< 21259,  31667> velocity=<-2, -3>\nposition=<-20807,  10641> velocity=< 2, -1>\nposition=<-31319,  10641> velocity=< 3, -1>\nposition=< 31746,  31667> velocity=<-3, -3>\nposition=<-31324,  31671> velocity=< 3, -3>\nposition=<-10278, -10398> velocity=< 1,  1>\nposition=<-10286,  42181> velocity=< 1, -4>\nposition=< 42257, -10390> velocity=<-4,  1>\nposition=<-52354,  10641> velocity=< 5, -1>\nposition=<-20845, -31423> velocity=< 2,  3>\nposition=< 21220, -31424> velocity=<-2,  3>\nposition=< 21230, -20904> velocity=<-2,  2>\nposition=<-52392, -41934> velocity=< 5,  4>\nposition=<-20793,  52694> velocity=< 2, -5>\nposition=< 10744, -41941> velocity=<-1,  4>\nposition=< 31758,  42185> velocity=<-3, -4>\nposition=<-20788,  21149> velocity=< 2, -2>\nposition=<-52346, -31428> velocity=< 5,  3>\nposition=< 31729, -20908> velocity=<-3,  2>\nposition=< 52804, -20909> velocity=<-5,  2>\nposition=<-20841,  52697> velocity=< 2, -5>\nposition=<-20820, -41934> velocity=< 2,  4>\nposition=<-20829, -41936> velocity=< 2,  4>\nposition=<-52375,  10632> velocity=< 5, -1>\nposition=<-41874,  42184> velocity=< 4, -4>\nposition=< 52756,  52700> velocity=<-5, -5>\nposition=< 42265,  42184> velocity=<-4, -4>\nposition=<-31364,  31668> velocity=< 3, -3>\nposition=<-10310,  42178> velocity=< 1, -4>\nposition=< 10716, -52454> velocity=<-1,  5>\nposition=< 31774, -41937> velocity=<-3,  4>\nposition=<-52389,  10638> velocity=< 5, -1>\nposition=< 31747,  52692> velocity=<-3, -5>\nposition=<-31316, -52457> velocity=< 3,  5>\nposition=< 52760, -31423> velocity=<-5,  3>\nposition=<-31305,  21151> velocity=< 3, -2>\nposition=< 10736, -31421> velocity=<-1,  3>\nposition=<-10326,  10634> velocity=< 1, -1>\nposition=<-41847, -20905> velocity=< 4,  2>\nposition=<-10286,  31666> velocity=< 1, -3>\nposition=< 31787, -20906> velocity=<-3,  2>\nposition=< 42290, -31419> velocity=<-4,  3>\nposition=< 21223, -10394> velocity=<-2,  1>\nposition=<-31306, -10394> velocity=< 3,  1>\nposition=<-20801,  21149> velocity=< 2, -2>\nposition=< 31753, -52449> velocity=<-3,  5>\nposition=< 31787,  21151> velocity=<-3, -2>\nposition=<-10314,  10634> velocity=< 1, -1>\nposition=< 42284,  21156> velocity=<-4, -2>\nposition=< 21235,  10632> velocity=<-2, -1>\nposition=< 21228,  31671> velocity=<-2, -3>\nposition=<-20825,  21147> velocity=< 2, -2>\nposition=< 31758,  21153> velocity=<-3, -2>\nposition=<-31305, -20909> velocity=< 3,  2>\nposition=< 42241,  42184> velocity=<-4, -4>\nposition=<-20801,  31663> velocity=< 2, -3>\nposition=< 52796, -52453> velocity=<-5,  5>\nposition=<-10334, -31423> velocity=< 1,  3>\nposition=< 52764, -31425> velocity=<-5,  3>\nposition=< 10720, -10393> velocity=<-1,  1>\nposition=<-20844, -31422> velocity=< 2,  3>\nposition=< 10704,  10635> velocity=<-1, -1>\nposition=< 42250,  52696> velocity=<-4, -5>\nposition=<-10273,  52695> velocity=< 1, -5>\nposition=< 10698,  31662> velocity=<-1, -3>\nposition=<-10278,  10638> velocity=< 1, -1>\nposition=< 21211,  52693> velocity=<-2, -5>\nposition=< 42298, -31424> velocity=<-4,  3>\nposition=<-10326,  52701> velocity=< 1, -5>\nposition=< 31760,  31671> velocity=<-3, -3>\nposition=< 10752,  10641> velocity=<-1, -1>\nposition=<-10313, -10398> velocity=< 1,  1>\nposition=<-31311,  31671> velocity=< 3, -3>\nposition=< 42273, -31422> velocity=<-4,  3>\nposition=< 10720,  42184> velocity=<-1, -4>\nposition=<-20845,  31670> velocity=< 2, -3>\nposition=<-31347,  10641> velocity=< 3, -1>\nposition=<-10332,  52692> velocity=< 1, -5>\nposition=<-31332, -31419> velocity=< 3,  3>\nposition=< 42293,  21156> velocity=<-4, -2>\nposition=<-31353,  10632> velocity=< 3, -1>\nposition=<-31316,  52699> velocity=< 3, -5>\nposition=<-31364,  21149> velocity=< 3, -2>\nposition=<-10278,  21156> velocity=< 1, -2>\nposition=< 42302, -31427> velocity=<-4,  3>\nposition=< 21219, -41942> velocity=<-2,  4>\nposition=< 31731,  52701> velocity=<-3, -5>\nposition=< 42241, -20909> velocity=<-4,  2>\nposition=<-31344, -10397> velocity=< 3,  1>\nposition=< 42277, -20904> velocity=<-4,  2>\nposition=<-10274, -41939> velocity=< 1,  4>\nposition=< 31782, -52450> velocity=<-3,  5>\nposition=<-41876,  31667> velocity=< 4, -3>\nposition=< 10749, -20904> velocity=<-1,  2>\nposition=< 21224, -20911> velocity=<-2,  2>\nposition=< 31734,  31662> velocity=<-3, -3>\nposition=< 21231,  10635> velocity=<-2, -1>\nposition=<-52389, -31419> velocity=< 5,  3>\nposition=< 31734, -41937> velocity=<-3,  4>\nposition=< 42257, -20905> velocity=<-4,  2>\nposition=< 42297,  52697> velocity=<-4, -5>\nposition=< 52805,  21156> velocity=<-5, -2>\nposition=< 10709, -20910> velocity=<-1,  2>\nposition=<-52370, -31420> velocity=< 5,  3>\nposition=<-10326,  21152> velocity=< 1, -2>")

(defn parse [input]
  (->> input
       (str/split-lines)
       (map (fn [raw-point]
              (partition 2 (map read-string (drop 1 (re-matches #"position=<\s?(-?\d+), \s?(-?\d+)> velocity=< ?(-?\d+),  ?(-?\d+)>" raw-point))))))))

(defn add-vectors [x y]
  (map + x y))

(defn tick [points]
  (->> points
       (map (fn [[position velocity]]
              [(add-vectors position velocity) velocity]))))

(defn is-adjacent [p1 p2]
  (let [[[x1 y1] _] p1
        [[x2 y2] _] p2]
    (and (>= 1 (- x1 x2) -1)
         (>= 1 (- y1 y2) -1))))

(defn get-cluster [points starting-point]
  (reduce (fn [cluster point]
            (if (some (partial is-adjacent point) cluster)
              (conj cluster point)
              cluster))
          #{starting-point}
          points))

(defn get-clusters [points]
  (loop [points-left (into #{} points)
         clusters []]
    (if (not (empty? points-left))
      (let [new-cluster (get-cluster (drop 1 points-left) (first points-left))]
        (recur (difference points-left new-cluster)
               (conj clusters new-cluster)))
      clusters)))

(defn visualize [points]
  (let [minx (->> points (map ffirst) (apply min))
        miny (->> points (map first) (map second) (apply min))
        point-set (->> points (map first) (into #{}))]
    (doall
      (for [y (range miny (+ miny 20))
            x (range minx (+ minx 100))]
        (do (when (= x minx) (print "\n"))
            (if (contains? point-set [x y]) (print "*") (print ".")))))
    nil))

(defn spy [x] (clojure.pprint/pprint x) x)
(defn spy-first [x] (clojure.pprint/pprint (first x)) x)

(defn part1 [input]
  (as-> input $
        (parse $)
        (loop [points $
               iterations 0]
          (if (< iterations 100000)
            (do (when (> 50 (count (get-clusters points))) (visualize points))
                (recur (spy-first (tick points))
                       (inc iterations)))
            nil))))

